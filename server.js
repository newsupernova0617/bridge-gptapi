import express from 'express';
import OpenAI from "openai";
import path from 'path';
import { fileURLToPath } from 'url';
import Database from 'better-sqlite3';
import { v4 as uuidv4 } from 'uuid';
import dayjs from 'dayjs';
import fs from 'fs';

import { GoogleGenAI } from "@google/genai";
// import dotenv from 'dotenv';
// dotenv.config(); 
const app = express();
const port = process.env.PORT || 3001;

app.use(express.json());
// __dirname ëŒ€ì²´ (ESMì—ì„œëŠ” ì§ì ‘ ì‚¬ìš© ë¶ˆê°€)
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// DB í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
const dbDir = path.join(__dirname, 'db');
if (!fs.existsSync(dbDir)) {
  fs.mkdirSync(dbDir);
}

// DB ì—°ê²°
const dbPath = path.join(dbDir, 'database.sqlite');
const db = new Database(dbPath);

// í…Œì´ë¸” ìƒì„± (ì—†ìœ¼ë©´ ìƒì„±)
db.prepare(`
  CREATE TABLE IF NOT EXISTS chats (
    id TEXT PRIMARY KEY,
    tags JSON,
    chat_created_at TEXT NOT NULL,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
  )
`).run();

// ê°€ëŠ¥í•œ tags ë¦¬ìŠ¤íŠ¸
const TAGS = [
  'êµí™˜', 'êµí™˜/ì‚¬ì´ì¦ˆ', 'êµí™˜/ì»¬ëŸ¬', 'êµí™˜/ì‚¬ì´ì¦ˆ/ì¬ê³ ë¬¸ì˜',
  'ë°°ì†¡', 'ë°°ì†¡/ìš´ì†¡ì¥ì¡°íšŒ',
  'ë§¤ì¥ë¬¸ì˜', 'ë§¤ì¥ë¬¸ì˜/ê°•ë‚¨ì ', 'ë§¤ì¥ë¬¸ì˜/ì—­ì‚¼ì ', 'ë§¤ì¥ë¬¸ì˜/ì‹ ì´Œì ', 'ë§¤ì¥ë¬¸ì˜/ì•ˆì•”ì ',
  'ë§¤ì¥ë¬¸ì˜/ê°•ë‚¨ì /ìš´ì˜ì‹œê°„', 'ë§¤ì¥ë¬¸ì˜/ì—­ì‚¼ì /ìš´ì˜ì‹œê°„', 'ë§¤ì¥ë¬¸ì˜/ì‹ ì´Œì /ìš´ì˜ì‹œê°„', 'ë§¤ì¥ë¬¸ì˜/ì•ˆì•”ì /ìš´ì˜ì‹œê°„',
  'ë§¤ì¥ë¬¸ì˜/ê°•ë‚¨ì /í”„ë¡œëª¨ì…˜', 'ë§¤ì¥ë¬¸ì˜/ì—­ì‚¼ì /í”„ë¡œëª¨ì…˜', 'ë§¤ì¥ë¬¸ì˜/ì‹ ì´Œì /í”„ë¡œëª¨ì…˜', 'ë§¤ì¥ë¬¸ì˜/ì•ˆì•”ì /í”„ë¡œëª¨ì…˜',
  'ë§¤ì¥ë¬¸ì˜/ê°•ë‚¨ì /ì¬ê³ ë¬¸ì˜', 'ë§¤ì¥ë¬¸ì˜/ì—­ì‚¼ì /ì¬ê³ ë¬¸ì˜', 'ë§¤ì¥ë¬¸ì˜/ì‹ ì´Œì /ì¬ê³ ë¬¸ì˜', 'ë§¤ì¥ë¬¸ì˜/ì•ˆì•”ì /ì¬ê³ ë¬¸ì˜',
  'ë§¤ì¥ë¬¸ì˜/êµí™˜í™˜ë¶ˆì•ˆë‚´',
  'ê²°ì œ', 'ê²°ì œ/í™˜ë¶ˆ', 'ê²°ì œ/í™˜ë¶ˆ/í™˜ë¶ˆì •ì±…', 'ê²°ì œ/í™˜ë¶ˆ/ë„¤ì´ë²„í˜ì´', 'ê²°ì œ/í™˜ë¶ˆ/ì¹´ì¹´ì˜¤í˜ì´',
  'ê²°ì œ/í™˜ë¶ˆ/ë¬´í†µì¥ì…ê¸ˆ', 'ê²°ì œ/í™˜ë¶ˆ/ì‹ ìš©ì¹´ë“œ',
  'ê²°ì œ/ì‚¬ì´íŠ¸ì˜¤ë¥˜/ëª¨ë°”ì¼ì•±', 'ê²°ì œ/ìˆ˜ë‹¨ë¬¸ì˜',
  'ì‚¬ì´íŠ¸ì˜¤ë¥˜', 'ì‚¬ì´íŠ¸ì˜¤ë¥˜/ëª¨ë°”ì¼ì•±',
  'ê±´ì˜ì‚¬í•­', 'ê±´ì˜ì‚¬í•­/ìƒí’ˆì¶”ê°€ìš”ì²­', 'ê±´ì˜ì‚¬í•­/ì„œë¹„ìŠ¤ê°œì„ ',
  'ê²°ì œ/ê²°ì œìˆ˜ë‹¨ë¬¸ì˜/ë„¤ì´ë²„í˜ì´', 'ê²°ì œ/ê²°ì œìˆ˜ë‹¨ë¬¸ì˜/ë¬´í†µì¥ì…ê¸ˆ', 'ê²°ì œ/ê²°ì œìˆ˜ë‹¨ë¬¸ì˜/ì‹ ìš©ì¹´ë“œ', 'ê²°ì œ/ê²°ì œìˆ˜ë‹¨ë¬¸ì˜/ì¹´ì¹´ì˜¤í˜ì´',
  'ê²°ì œ/ë‚´ì—­ë¬¸ì˜', 'ê²°ì œ/ê²°ì œìˆ˜ë‹¨ë¬¸ì˜', 'ê²°ì œ/ë°©ë²•ì•ˆë‚´',
  'êµí™˜/ì˜¨ë¼ì¸', 'ìƒí’ˆë¬¸ì˜', 'ìƒí’ˆë¬¸ì˜/ì‹ ìƒí’ˆ', 'ìƒí’ˆë¬¸ì˜/ê¸°íƒ€'
];

// ëœë¤ ë‚ ì§œ ìƒì„± (2020-10-01 ~ 2020-10-31)
function randomDate() {
  const start = dayjs('2020-10-01');
  const end = dayjs('2020-10-31');
  const diff = end.diff(start, 'day');
  const randomDays = Math.floor(Math.random() * (diff + 1));
  return start.add(randomDays, 'day').format('YYYY-MM-DD HH:mm:ss');
}

// mock ë°ì´í„° ìƒì„±
function generateMock() {
  const id = uuidv4();
  const randomTags = [];

  // íƒœê·¸ 1~3ê°œ ëœë¤ ì„ íƒ
  const numTags = Math.floor(Math.random() * 3) + 1;
  for (let i = 0; i < numTags; i++) {
    randomTags.push(TAGS[Math.floor(Math.random() * TAGS.length)]);
  }

  const date = randomDate();

  return {
    id,
    tags: JSON.stringify(randomTags),
    chat_created_at: date,
    created_at: date,
    updated_at: date
  };
}

// mock ë°ì´í„° ì‚½ì…
app.all('/seed', (req, res) => {
  const count = req.body.count || 50000;
  const insert = db.prepare(`
    INSERT INTO chats (id, tags, chat_created_at, created_at, updated_at)
    VALUES (@id, @tags, @chat_created_at, @created_at, @updated_at)
  `);

  const insertMany = db.transaction((records) => {
    for (const record of records) insert.run(record);
  });

  const mocks = Array.from({ length: count }, generateMock);
  insertMany(mocks);

  res.json({ message: `${count}ê°œì˜ mock ë°ì´í„°ê°€ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.` });
});

// ì „ì²´ ë°ì´í„° ì¡°íšŒ
app.get('/chats', (req, res) => {
  const rows = db.prepare('SELECT * FROM chats').all();
  res.json(rows);
});

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY, // .env
});

const genAI  = new GoogleGenAI({apiKey: process.env.GEMINI_API_KEY,});



app.use(express.static(path.join(__dirname, 'public')));

app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});


// âœ… ë¦¬í¬íŠ¸ ìƒì„± ì—”ë“œí¬ì¸íŠ¸
app.post("/report", async (req, res) => {
  try {
    const input_json = await req.body;

    const response = await client.responses.create({
      model: "gpt-5-mini",
      reasoning: { effort: "minimal" },
      instructions: `
### role ###

ë„ˆëŠ” 10ë…„ì°¨ CXíŒ€ ë¦¬ë”ì•¼. 8ì£¼ê°„ì˜ ìƒë‹´íƒœê·¸ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  íƒœê·¸ë³„ ì¦ê° ì¶”ì´ë¥¼ í™•ì¸í•´ì„œ ì¸ì‚¬ì´íŠ¸ë¥¼ ë½‘ì•„ì•¼ í•´.

ì¸ì‚¬ì´íŠ¸ëŠ” ì•„ë˜ì— ì£¼ì–´ì§€ëŠ” dataì™€ ê¸°ì—… íŠ¹ì´ì‚¬í•­ì„ ë°˜ì˜í•´ì„œ ì¸ì‚¬ì´íŠ¸ë¥¼ ë½‘ì•„ì¤˜.

1. ì´ì „ 4ì£¼ì™€ ë¹„êµí•´ ê³¼í•˜ê²Œ ì¦ê°€/ê°ì†Œí•œ íƒœê·¸

1-1. ì¦ê°í•œ ì´ìœ ë¥¼ ê¸°ì—… íŠ¹ì´ì‚¬í•­ì—ì„œ ì°¾ì•„ì•¼ í•´

1-2. ì¦ê°í•œ ë¹„ìœ¨ì„ ëª…í™•í•˜ê²Œ ì–¸ê¸‰í•´ì•¼í•´. (ex: ì „ì£¼ ëŒ€ë¹„ 50% ê°ì†Œ)

2. ê¸°ì—… íŠ¹ì´ì‚¬í•­ì— ì–¸ê¸‰ëœ íƒœê·¸

2-1.ê¸°ì—… íŠ¹ì´ì‚¬í•­ì—ì„œ ì–¸ê¸‰ëœ ì˜ˆìƒì¹˜ì— ë¹„í•´ ë§ì´ ë²—ì–´ë‚˜ëŠ” ê²½ìš° ì¸ì‚¬ì´íŠ¸ë¡œ ì„¤ëª… (ex: ë¸”ë™í”„ë¼ì´ë°ì´ ì„¸ì¼ë¡œ ì¸í•´ 100ê±´ ì •ë„ ë“¤ì–´ì˜¬ ê²ƒìœ¼ë¡œ ì˜ˆìƒí•œ í™˜ë¶ˆë¬¸ì˜ê°€ 4ê±´ë§Œ ë“¤ì–´ì™€ì„œ ì´ë¡€ì ì¸ ìˆ˜ì¹˜ì´ë‹¤)

3. ì¸ì‚¬ì´íŠ¸ëŠ” í•œêµ­ì–´ë¥¼ ë””í´íŠ¸ë¡œ í•˜ê³  ì˜ì–´ì™€ ì¼ë³¸ì–´ëŠ” í•œêµ­ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë²ˆì—­í•´ì„œ ë½‘ì•„ì¤˜

4. ì¶œë ¥í˜•ì‹ì€ jsonìœ¼ë¡œ ,í˜•ì‹ì€ ë‹¤ìŒê³¼ ê°™ì´ ë§Œë“¤ì–´ì¤˜
{

"kor":{"greeting_kor":{ì¸ì‚¬ë§},
        "insight1_kor":{ì²«ë²ˆì§¸ ì¸ì‚¬ì´íŠ¸},
        "insight2_kor":{ë‘ë²ˆì§¸ ì¸ì‚¬ì´íŠ¸},
        "insight3_kor":{ì„¸ë²ˆì§¸ ì¸ì‚¬ì´íŠ¸},
},

"eng":{"greeting_eng":"{ì¸ì‚¬ë§}",
        "insight1_eng":{í•œêµ­ì–´ ì²«ë²ˆì§¸ ì¸ì‚¬ì´íŠ¸ ì˜ì–´ ë²ˆì—­ë³¸},
        "insight2_eng":{í•œêµ­ì–´ ë‘ë²ˆì§¸ ì¸ì‚¬ì´íŠ¸ ì˜ì–´ ë²ˆì—­ë³¸},
        "insight3_eng":{í•œêµ­ì–´ ì„¸ë²ˆì§¸ ì¸ì‚¬ì´íŠ¸ ì˜ì–´ ë²ˆì—­ë³¸},
},

"jpn":{"greeting_jpn":"{ì¸ì‚¬ë§}",
        "insight1_jpn":{ì²«ë²ˆì§¸ ì¸ì‚¬ì´íŠ¸ ì¼ë³¸ì–´ ë²ˆì—­ë³¸},
        "insight2_jpn":{ë‘ë²ˆì§¸ ì¸ì‚¬ì´íŠ¸ ì¼ë³¸ì–´ ë²ˆì—­ë³¸},
        "insight3_jpn":{ì„¸ë²ˆì§¸ ì¸ì‚¬ì´íŠ¸ ì¼ë³¸ì–´ ë²ˆì—­ë³¸},
}
}

### instruction ###

ì…ë ¥ìœ¼ë¡œ ì£¼ì–´ì§€ëŠ” JSON ë°ì´í„°ì—ëŠ” ê³ ê° ë¬¸ì˜ í†µê³„ì™€ ì£¼ìš” ì´ìŠˆ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆì–´.

Dataë¥¼ ë¶„ì„í•˜ê³  exampleë¥¼ ì°¸ê³ í•´.

### output instruction ###

{yearweek}

{ì¸ì‚¬ë§}

{ê³ ê° ìƒë‹´ ì¸ì‚¬ì´íŠ¸ 3ì¤„}

### output example ###

{}ì•ˆì— ìˆëŠ” ë§ì€ ë¬´ì‹œí•´ì¤˜ ê·¸ëƒ¥ ë„ˆì—ê²Œ ì£¼ëŠ” ì°¸ê³ ìš© ì´ì •í‘œì•¼

í˜•ì‹:

#example_1

Yearweek:10ì›” 3ì£¼ì°¨

{ì¸ì‚¬ë§} ì•ˆë…•í•˜ì„¸ìš”! ë‚™ì—½ì´ ì ˆì •ì„ ì´ë£¨ëŠ” 10ì›” 3ì£¼ì°¨ì…ë‹ˆë‹¤. ì§€ë‚œ í•œ ì£¼ê°„ ê³ ê°ë“¤ì˜ ì£¼ìš” ë¬¸ì˜ì‚¬í•­ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.

{ê³ ê° ìƒë‹´ ì¸ì‚¬ì´íŠ¸ 3ì¤„}

ì´ë²ˆ ì£¼ì—ëŠ” ìƒˆë¡­ê²Œ ì¶œì‹œëœ 'ê°€ì„ í•œì •íŒ' íŒ¨í‚¤ì§€ì˜ êµ¬ì„±í’ˆ ë³€ê²½ ê°€ëŠ¥ ì—¬ë¶€ ë¬¸ì˜ê°€ ê°€ì¥ ë§ì•˜ìŠµë‹ˆë‹¤. í˜„ì¬ ê¸°íš ì˜ë„ì™€ ë§ì§€ ì•Šì•„ ë³€ê²½ì´ ì–´ë µë‹¤ê³  ì•ˆë‚´í•˜ê³  ìˆìœ¼ë‚˜, ê³ ê°ì˜ ìš”êµ¬ê°€ ì§€ì†ë˜ì–´ ê¸ì •ì ì¸ ê²€í† ê°€ í•„ìš”í•´ ë³´ì…ë‹ˆë‹¤.

ë”ë¶ˆì–´ ë°°ì†¡ ì§€ì—°ì— ëŒ€í•œ ë¬¸ì˜ê°€ ì „ ì£¼ ëŒ€ë¹„ 2ë°° ì´ìƒ ê¸‰ì¦í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì§€ë‚œì£¼ë¶€í„° ì‹œì‘ëœ íƒë°°ì‚¬ì˜ íŒŒì—… ì˜ˆê³ ì™€ ë§ë¬¼ë¦° í˜„ìƒìœ¼ë¡œ ë³´ì´ë©°, ê³ ê°ë“¤ì—ê²Œ ì •í™•í•œ ì§€ì—° ì˜ˆìƒ ì¼ìë¥¼ ê³µì§€í•˜ëŠ” ê²ƒì´ ì‹œê¸‰í•©ë‹ˆë‹¤.

ë§ë¶™ì—¬, ì§€ë‚œë‹¬ë¶€í„° ë¬¸ì œê°€ ë˜ì—ˆë˜ ë¡œê·¸ì¸ ì‹œ 'ë¹„ë°€ë²ˆí˜¸ 5íšŒ ì˜¤ë¥˜' ì ê¸ˆ í˜„ìƒì´ CS ì±„ë„ë¡œ ì ‘ìˆ˜ëœ ê±´ì´ 0ê±´ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤! ê°œë°œíŒ€ì—ì„œ ì ìš©í•œ 'ì ê¸ˆ í•´ì œ ê°„ì†Œí™”' íŒ¨ì¹˜ê°€ íš¨ê³¼ë¥¼ ë³¸ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.

#example_2

Yearweek: 11ì›” 4ì£¼ì°¨

{ì¸ì‚¬ë§}

ì•ˆë…•í•˜ì„¸ìš”! ìŒ€ìŒ€í•œ ë‚ ì”¨ê°€ ì˜·ê¹ƒì„ ì—¬ë¯¸ê²Œ í•˜ëŠ” 11ì›” 4ì£¼ì°¨ì…ë‹ˆë‹¤. ê³ ê°ë“¤ì˜ ëª©ì†Œë¦¬ë¥¼ í†µí•´ ì´ë²ˆ ì£¼ì˜ ì£¼ìš” ì´ìŠˆë¥¼ íŒŒì•…í•´ ë´…ì‹œë‹¤.

{ê³ ê° ìƒë‹´ ì¸ì‚¬ì´íŠ¸ 3ì¤„}

ì´ë²ˆ ì£¼ì—ëŠ” 'ì¹œêµ¬ ì¶”ì²œ' ì´ë²¤íŠ¸ ë³´ìƒ ì§€ê¸‰ ëˆ„ë½ì— ëŒ€í•œ ë¬¸ì˜ê°€ ë‹¤ìˆ˜ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œ ë¡œê·¸ë¥¼ í™•ì¸í•œ ê²°ê³¼, íŠ¹ì • OS í™˜ê²½ì—ì„œ ì¶”ì²œ ì½”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì§€ ì•ŠëŠ” ë²„ê·¸ë¡œ í™•ì¸ë˜ì–´ ë¹ ë¥¸ ì‹œì¼ ë‚´ ìˆ˜ì • ë° ì¼ê´„ ì§€ê¸‰ì´ í•„ìš”í•©ë‹ˆë‹¤.

ë”ë¶ˆì–´ ì˜¤í”„ë¼ì¸ ë§¤ì¥ì—ì„œ ê¸°íšìƒí’ˆ íŒë§¤ ìš”ì²­ì´ ëˆˆì— ë„ê²Œ ëŠ˜ì—ˆìŠµë‹ˆë‹¤. ì—°ë§ ì‹œì¦Œì„ ì•ë‘ê³  ìˆì–´ ê³ ê°ë“¤ì´ ë” ë‹¤ì–‘í•œ ìƒí’ˆì„ ê³ ê°ë“¤ì´ ì‹¤ì²´ë¡œ ì²´í—˜í•˜ê³  êµ¬ë§¤í•˜ê¸°ë¥¼ ì›í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.

ë§ë¶™ì—¬, ê³ ê°ì´ ì§ì ‘ ì£¼ë¬¸ ë‚´ì—­ì—ì„œ ë°°ì†¡ì§€ ì£¼ì†Œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆê²Œ ê°œì„ ëœ ì´í›„, 'ë°°ì†¡ì§€ ë³€ê²½ ìš”ì²­' ê´€ë ¨ CS ì ‘ìˆ˜ ê±´ìˆ˜ê°€ 90% ì´ìƒ ê°ì†Œí•˜ëŠ” ê¸ì •ì ì¸ íš¨ê³¼ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤!

#example_3

yearweek: 12ì›” 1ì£¼ì°¨

{ì¸ì‚¬ë§} ì•ˆë…•í•˜ì„¸ìš”! í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë¶„ìœ„ê¸°ê°€ ë¬¼ì”¬ ëŠê»´ì§€ëŠ” 12ì›”ì˜ ì²«ì§¸ ì£¼ì…ë‹ˆë‹¤. ì§€ë‚œ í•œ ì£¼ê°„ ê³ ê°ì„¼í„°ë¡œ ì ‘ìˆ˜ëœ ì£¼ìš” ì´ìŠˆë“¤ì„ ê³µìœ í•©ë‹ˆë‹¤.

{ê³ ê° ìƒë‹´ ì¸ì‚¬ì´íŠ¸ 3ì¤„}

ì´ë²ˆ ì£¼ì—ëŠ” í¬ë¦¬ìŠ¤ë§ˆìŠ¤ í•œì • ìƒí’ˆ í’ˆì ˆ ì‹œì ì— ëŒ€í•œ ë¬¸ì˜ì™€ ë¶ˆë§Œì´ í­ë°œì ìœ¼ë¡œ ì¦ê°€í–ˆìŠµë‹ˆë‹¤. ì¤€ë¹„ëœ ìˆ˜ëŸ‰ì´ ì˜ˆìƒë³´ë‹¤ ë¹¨ë¦¬ ì†Œì§„ë˜ì–´, ê³ ê°ë“¤ì€ ì¬ì…ê³  ì¼ì • ë° ì˜ˆì•½ êµ¬ë§¤ ê°€ëŠ¥ ì—¬ë¶€ì— ëŒ€í•œ ëª…í™•í•œ ë‹µë³€ì„ ê°•ë ¥í•˜ê²Œ ìš”êµ¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ë”ë¶ˆì–´ ì‹ ê·œ ê²°ì œ ìˆ˜ë‹¨ì¸ ë„¤ì´ë²„í˜ì´ ì´ìš© ì‹œ í• ì¸ì¿ í° ë¯¸ì ìš© ì˜¤ë¥˜ ë¬¸ì˜ê°€ ì§‘ì¤‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œ ì—°ë™ ë¬¸ì œë¡œ ë³´ì´ë©°, ê³ ê°ì˜ ë¶ˆí¸ í•´ì†Œë¥¼ ìœ„í•´ ê²°ì œíŒ€ì˜ ê¸´ê¸‰ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.
      `,
      input: `ë‹¤ìŒ ë°ì´í„°ë¥¼ ë¶„ì„í•´ì¤˜:\n\`\`\`json\n${JSON.stringify(input_json, null, 2)}\n\`\`\``,
    });

    res.status(200).send(response.output_text);
  } catch (error) {
    console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
    res.status(500).send(`ì„œë²„ ì˜¤ë¥˜: ${error.message}`);
  }
});





app.get("/follow_up", async (req, res) => {
  try {
    const input_json = await getExternalData();

    if (!input_json || input_json.length === 0) {
      return res.status(400).json({ error: "ì…ë ¥ ì¼ì • ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤." });
    }

    const response = await client.responses.create({
      model: "gpt-5-nano",
      reasoning: { effort: "low" },
      instructions: 
    //   í”„ë¡¬í”„íŠ¸ ë‹¤ì‹œ ë´ì•¼í•¨
    `
ë„ˆëŠ” jsonì•ˆì˜ tagsì˜ ì¤‘ìš”ë„ë¥¼ 1~5ë¡œ í‰ê°€í•˜ëŠ” AIì•¼.
ì¤‘ìš”ë„ 5ê°€ ê°€ì¥ ì¤‘ìš”í•˜ê³ , ì¤‘ìš”ë„ 1ì´ ê°€ì¥ ì¤‘ìš”í•˜ì§€ ì•Šì•„.
ì…ë ¥ì€ JSON ë°°ì—´ í˜•íƒœì˜ íŠ¹ì´ì‚¬í•­ë“¤ì´ê³ , jsonì•ˆì— tags í•„ë“œê°€ ìˆì–´, ì´ ê°’ì„ ë³´ê³  
ê° jsonì— "priority" í•„ë“œë¥¼ ì¶”ê°€í•´ì„œ JSON ë°°ì—´ë¡œ ê·¸ëŒ€ë¡œ ë°˜í™˜í•´ì¤˜.


      `,
      input: `ë‹¤ìŒ tagsë“¤ì˜ ì¤‘ìš”ë„ë¥¼ 1~5ë¡œ íŒë³„:\n\`\`\`json\n${JSON.stringify(input_json, null, 2)}\n\`\`\``,
    });

    const outputText =
      response.output_text ||
      response.output?.[0]?.content?.[0]?.text ||
      "ì¶œë ¥ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.";

    res.status(200).json({ result: outputText });
  } catch (error) {
    console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
    res.status(500).json({ error: error.message });
  }
});

// âœ… ì„œë²„ ì‹¤í–‰
app.listen(port, () => {
  console.log(`ğŸš€ ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${port}`);
});







